# Copyright 2020-2026 Lowdefy, Inc

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

_ref:
  path: templates/general.yaml.njk
  vars:
    pageId: e2e-getting-started
    pageTitle: Getting Started
    section: Testing
    filePath: testing/e2e-getting-started.yaml
    content:
      - id: md1
        type: MarkdownWithCode
        properties:
          content: |
            ## Setup

            The fastest way to set up e2e testing is with the scaffold command. Run this in your project root:

            ```
            npx @lowdefy/e2e-utils
            ```

            The command will:
            - Detect your Lowdefy app (single-app or multi-app)
            - Ask if you want MongoDB testing support
            - Create test files in an `e2e/` directory
            - Update your `package.json` with test scripts
            - Update `.gitignore` with test artifacts
            - Optionally install dependencies and Playwright browsers

            ## Generated files

            After running the scaffold command, your project will have:

            ```
            e2e/
              playwright.config.js    # Playwright configuration
              fixtures.js             # Test fixtures (provides the ldf helper)
              mocks.yaml              # Static request mocks
              example.spec.js         # Example test to get you started
            ```

            ## Running tests

            Run all tests:
            ```
            pnpm e2e
            ```

            Run tests with the Playwright UI (useful for debugging):
            ```
            pnpm e2e:ui
            ```

      - id: first_run_alert
        type: Alert
        properties:
          type: info
          showIcon: false
          message: The first run will take longer because Playwright needs to build and start your Lowdefy app. Subsequent runs reuse the server if it is still running.

      - id: md2
        type: MarkdownWithCode
        properties:
          content: |
            ## Your first test

            The generated `example.spec.js` looks like this:

            ```javascript
            import { test, expect } from './fixtures.js';

            test('homepage loads', async ({ ldf }) => {
              await ldf.goto('/');
              await expect(ldf.page).toHaveTitle(/./);
            });
            ```

            Let's break this down:

            - `import { test, expect } from './fixtures.js'` — imports the enhanced test function that provides the `ldf` helper
            - `test('...', async ({ ldf }) => { ... })` — the `ldf` object is automatically created for each test with a fresh browser page
            - `await ldf.goto('/')` — navigates to the homepage and waits for the Lowdefy client to initialize
            - `await expect(ldf.page).toHaveTitle(/./)` — uses the raw Playwright page to assert the page has a title

            ## Writing a real test

            Here is a more practical example. Suppose you have a page with a search form:

            ```javascript
            import { test } from './fixtures.js';

            test('search returns results', async ({ ldf }) => {
              await ldf.goto('/search');

              // Fill in the search input and click search
              await ldf.block('search_input').do.fill('widget');
              await ldf.block('search_btn').do.click();

              // Wait for the request to complete
              await ldf.request('search_products').expect.toFinish();

              // Check that results appeared in state
              const results = await ldf.state('search_results').value();
              expect(results.length).toBeGreaterThan(0);
            });
            ```

            ## What happens behind the scenes

            When you run `pnpm e2e`:

            1. Playwright reads `playwright.config.js`, which uses `createConfig()` from `@lowdefy/e2e-utils/config`
            2. The config starts a web server that builds your app with `NEXT_PUBLIC_LOWDEFY_E2E=true` and starts it
            3. A manifest is generated from your build artifacts, mapping block IDs to their types and e2e helpers
            4. For each test, a fresh `ldf` object is created with a new browser page, and any static mocks from `mocks.yaml` are applied
            5. Your test code runs against the live app

      - _ref:
          path: templates/navigation_buttons.yaml
          vars:
            previous_page_title: Introduction
            previous_page_id: e2e-introduction
            next_page_title: Writing Tests
            next_page_id: e2e-writing-tests
